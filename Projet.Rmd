---
title: " Income Disparity-USA Bayesian Analysis"
author: "Taqwa Ben Romdhane"
        "Khalil Ounis"
        "Manal Derghal"
        "Fanny Sammut"
        "Alix Madrange"
date: "2025-03-25"
output: ioslides_presentation:
  toc: true
  toc_depth : 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

### 1. Introdcution :

\@ While the gender pay gap is persistent and significant, people of all genders are subject to disparities in pay. Another ongoing discussion in the United States is that of the racial wage gap,[given the disparities in median household income across racial and ethnic groups].Black American households had a median income of 56,490 U.S. dollars in 2023, significantly lower than the median income of white households which stood at 89,050 U.S. dollars in the same year. Wage inequality in the U.S. - statistics & facts. Statistica

A partir d'un échantillon de 534 américains décrits par 11 covariables, nous allons mener une analyse bayésienne de la disparité des revenus de la population aux étas unis.

Dans notre analyse, nous nous concentrons principalement sur l'étude des questions suivantes :

-   Comment les salaires horaires diffèrent-ils entre les hommes et les          femmes ayant des caractéristiques observées similaires ?

-   Disparités de revenus parmi les ethnicités
-   Disparité des revenues entre les femmes mariées et célibataires
-   Quels facteurs expliquent les disparités de revenus observées ?

## 2. Table de contenus :

-   Bullet 1
-   Bullet 2
-   Bullet 3

## Slide with R Output

```{r}
# Charger les bibliothèques nécessaires
library(dplyr)
library(ggplot2)
library(tidyverse)
library(runjags)
```

```{r cars, echo = TRUE}
Wage_data = read.csv("C:/Users/khali/Desktop/Polytech S9/M2DS/Bayesian Stat/Wage/wage_data.csv", header=TRUE, sep=",")
```


1. Prétraitement des données
```{r}

# check the data
selected_data1 <- Wage_data %>% select(education, south, female, workexp, unionmember, wages)
selected_data2 <- Wage_data %>% select(age, ethnicity, occupation, sector, married)
as.data.frame(head(glimpse(selected_data1), n=5))
as.data.frame(head(glimpse(selected_data2), n=5))
```

Notre jeu de données Wage_data contient les variables suivantes :
* education: Années d'études
* south: Indicateur de la région sud
* female: Indicateur de genre (0 = Homme, 1 = Femme)
* workexp: Années d'expérience professionnelle
* unionmember: Indicateur de membre du syndicat
* wages: Salaire horaire
* age: Âge
* ethnicity: Ethnicité (White, Hispanic, Other)
* occupation: Occupation (Management, Sales, Clerical, Professional, Service, Other)
* sector: Secteur d'activité (Manufactoring, Construction, Other)
* married: Indicateur de statut marital


```{r}
# copy <- Wage_data

age_bins <- c(18,30, 45, 60, Inf)
age_labels <- c("Y18-30", "Y30-45", "Y45-60", "Y60+")

# Transformer la variable age en catégories
Wage_data$age_group<- cut(Wage_data$age, breaks = age_bins, labels = age_labels, right = FALSE)

# Convertir en factors
Wage_data[c("south", "female", "unionmember", "ethnicity", "occupation", "sector","married")] <- lapply(Wage_data[c("south", "female", "unionmember", "ethnicity", "occupation", "sector","married")], factor)

```

```{r}
min(Wage_data$education) # 2
max(Wage_data$education) # 18
min(Wage_data$workexp) # 0
max(Wage_data$workexp)  # 55
```

2. Analyse descriptive et visualisation

```{r}
# Liste des variables quantitatives
numeric_vars <- c("education", "workexp", 
                  "wages","age")
Wage_data[numeric_vars] <- lapply(Wage_data[numeric_vars], function(x) as.numeric(as.character(x)))
# Boucle pour afficher les distributions
for (var in numeric_vars) {
  print(
    ggplot(Wage_data, aes_string(x = var)) +
      geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
      geom_density(color = "darkblue", size = 1) +
      labs(title = paste("Distribution de la variable :", var),
           x = var,
           y = "Densité") +
      theme_minimal()
  )
}

cat_vars <- c("south", "female", "unionmember", "ethnicity", "occupation", "sector", "married", "age_group")

for (var in cat_vars) {
  print(
    ggplot(Wage_data, aes_string(x = var)) +
      geom_bar(fill = "purple") +
      labs(title = paste("Distribution de la variable :", var),
           x = var, y = "Effectif") +
      theme_minimal()
  )
}

```

```{r}
# Load libraries
# Load libraries
library(runjags)
library(coda)
library(ggplot2)
library(dplyr)

# Prepare data
age_counts <- table(Wage_data$age_group)
y <- as.numeric(age_counts)
n <- sum(y)
k <- length(y)

# JAGS model
model_string <- "
model {
  p[1:k] ~ ddirch(alpha[1:k])
  y[1:k] ~ dmulti(p[1:k], n)
}
"

# Dirichlet prior
alpha <- rep(1, k)
data_jags <- list(y = y, n = n, k = k, alpha = alpha)

# Run JAGS
model <- run.jags(
  model = model_string,
  data = data_jags,
  monitor = "p",
  n.chains = 3,
  adapt = 1000,
  burnin = 1000,
  sample = 5000,
  summarise = TRUE,
  method = "rjags"
)

# Extract MCMC samples
mcmc_samples <- as.mcmc.list(model)
nchains <- length(mcmc_samples)

# Combine all chains into one long-format data frame
samples_df <- do.call(rbind, lapply(1:nchains, function(i) {
  df <- as.data.frame(mcmc_samples[[i]])
  df$iteration <- 1:nrow(df)
  df$chain <- factor(paste0("Chain ", i))
  return(df)
}))

# Check actual column names
print(names(samples_df))  # You'll likely see p.1, p.2, ...

library(rlang)

for (i in 1:k) {
  param <- paste0("p[", i, "]")
  
  # Check if the parameter column exists and is not all NA
  if (param %in% names(samples_df) && !all(is.na(samples_df[[param]]))) {
    p <- ggplot(samples_df, aes(x = iteration, y = .data[[param]], color = .data$chain)) +
      geom_line() +
      labs(title = paste("Traceplot for", param),
           x = "Iteration",
           y = "Sampled value") +
      theme_minimal()
    
    print(p)  # Force plot rendering
  } else {
    message(paste("Skipping", param, "- column not found or contains only NA values."))
  }
}


```


#Posterior Check : Predictive Count simulation
```{r}
mcmc_samples <- as.mcmc.list(model)

posterior_draws <- as.data.frame(do.call(rbind, mcmc_samples))

set.seed(123)  # For reproducibility

# Sample one posterior draw
sample_index <- sample(1:nrow(posterior_draws), 1)
p_sim <- as.numeric(posterior_draws[sample_index, 1:k])  # First k columns = p[1] to p[k]

# Simulate new counts from multinomial
y_sim <- rmultinom(1, size = n, prob = p_sim)
y_sim_vec <- as.numeric(y_sim)

barplot(
  rbind(Observed = y, Simulated = y_sim_vec),
  beside = TRUE,
  col = c("skyblue", "tomato"),
  legend = TRUE,
  main = "Posterior Predictive Check: Observed vs Simulated Counts",
  names.arg = names(age_counts)  # must match number of age groups
)


```

##### Fake data check for age
```{r}
true_p <- prop.table(table(Wage_data$age_group))
k <- length(true_p)
n <- 500  # sample size

set.seed(42)
y_fake <- as.numeric(rmultinom(1, size = n, prob = true_p))

alpha <- rep(1, k)  # non-informative prior
data_jags_fake <- list(y = y_fake, n = n, k = k, alpha = alpha)

model_string <- "
model {
  p[1:k] ~ ddirch(alpha[1:k])
  y[1:k] ~ dmulti(p[1:k], n)
}
"

library(runjags)

model_fake <- run.jags(
  model = model_string,
  data = data_jags_fake,
  monitor = "p",
  n.chains = 3,
  adapt = 1000,
  burnin = 1000,
  sample = 5000,
  summarise = TRUE,
  method = "rjags"
)

posterior_draws <- as.data.frame(do.call(rbind, as.mcmc.list(model_fake)))

posterior_summary <- data.frame(
  parameter = paste0("p[", 1:k, "]"),
  true_value = true_p,
  mean = colMeans(posterior_draws[, 1:k]),
  lower = apply(posterior_draws[, 1:k], 2, quantile, 0.025),
  upper = apply(posterior_draws[, 1:k], 2, quantile, 0.975)
)

library(ggplot2)

ggplot(posterior_summary, aes(x = mean, y = reorder(parameter, mean))) +
  geom_point(color = "black", size = 3) +
  geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.2, color = "red") +
  labs(title = "Posterior credible intervals ",
       x = "Value",
       y = NULL) +
  theme_minimal()

```



##### Modélisation bayésienne des disparités de salaires par genre


```{r}
library(runjags)

model_string <- "
model {
  for (i in 1:N) {
    wages[i] ~ dnorm(mu_sex[sex[i]], tau)
  }
  for (j in 1:2) {
    mu_sex[j] ~ dnorm(0, 10)
  }
  tau <- pow(sigma, -2)
  sigma ~ dunif(0, 100)
}
"

data_jags <- list(
  wages = Wage_data$wages,
  sex = as.numeric(factor(Wage_data$female)),
  N = nrow(Wage_data),
  K = 2
)

inits <- function() {
  list(mu_sex = rnorm(2), sigma = runif(1))
}

parameters <- c("mu_sex", "sigma")

results_sex <- run.jags(model = model_string, data = data_jags, inits = inits, n.chains = 3, burnin = 1000, sample = 5000, monitor = parameters)

cat("Résultats du modèle JAGS pour la variable sex:\n")
as.data.frame(summary(results))

```
```{r}
plot_credible_intervals(results_sex)
```

```{r}

```


## Régression bayésienne

```{r pressure}

model_string_regression <- "
model {
  for (i in 1:N) {
    wages[i] ~ dnorm(mu[i], tau)
    mu[i] <- beta0 + beta1 * education[i] + beta2 * south[i] + beta3 * female[i] + beta4 * workexp[i] + beta5 * unionmember[i] + beta6 * age[i] + beta7 * ethnicity[i] + beta8 * occupation[i] + beta9 * sector[i] + beta10 * married[i]
  }
  beta0 ~ dnorm(0, 0.0001)
  beta1 ~ dnorm(0, 0.0001)
  beta2 ~ dnorm(0, 0.0001)
  beta3 ~ dnorm(0, 0.0001)
  beta4 ~ dnorm(0, 0.0001)
  beta5 ~ dnorm(0, 0.0001)
  beta6 ~ dnorm(0, 0.0001)
  beta7 ~ dnorm(0, 0.0001)
  beta8 ~ dnorm(0, 0.0001)
  beta9 ~ dnorm(0, 0.0001)
  beta10 ~ dnorm(0, 0.0001)
  tau <- pow(sigma, -2)
  sigma ~ dunif(0, 100)
}
"

data_jags_regression <- list(
  wages = Wage_data$wages,
  education = Wage_data$education,
  south = as.numeric(Wage_data$south),
  female = as.numeric(Wage_data$female),
  workexp = Wage_data$workexp,
  unionmember = as.numeric(Wage_data$unionmember),
  age = as.numeric(Wage_data$age),
  ethnicity = as.numeric(factor(Wage_data$ethnicity)),
  occupation = as.numeric(factor(Wage_data$occupation)),
  sector = as.numeric(factor(Wage_data$sector)),
  married = as.numeric(Wage_data$married),
  N = nrow(Wage_data)
)

inits_regression <- function() {
  list(beta0 = rnorm(1), beta1 = rnorm(1), beta2 = rnorm(1), beta3 = rnorm(1), beta4 = rnorm(1), beta5 = rnorm(1), beta6 = rnorm(1), beta7 = rnorm(1), beta8 = rnorm(1), beta9 = rnorm(1), beta10 = rnorm(1), sigma = runif(1))
}

parameters_regression <- c("beta0", "beta1", "beta2", "beta3", "beta4", "beta5", "beta6", "beta7", "beta8", "beta9", "beta10", "sigma")

results_regression <- run.jags(model = model_string_regression, data = data_jags_regression, inits = inits_regression, n.chains = 3, burnin = 1000, sample = 5000, monitor = parameters_regression)

summary(results_regression)

```

```{r}

```

```{r}

```



```{r}

```




